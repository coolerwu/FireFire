# Build and release workflow for FireFire
# Builds for Windows, macOS (Intel + Apple Silicon), and Linux

name: build release

on:
  push:
    branches: [ "master" ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [ 16.x ]
    env:
      CI: false
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm config set optional false
      - run: npm install --no-audit
      - name: Rebuild native modules
        run: npx @electron/rebuild -f -w better-sqlite3
      - run: npm run build --if-present
      - name: 读取当前版本号
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      - run: npm run package-linux
      - run: mv ./target/firefire_${{steps.version.outputs.value}}_amd64.deb ./target/firefire-${{steps.version.outputs.value}}.deb
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.deb
          path: ./target/firefire-${{steps.version.outputs.value}}.deb

  build-win:
    runs-on: windows-latest
    strategy:
      matrix:
        node-version: [ 16.x ]
    env:
      CI: false
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Setup Python for node-gyp
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          npm config set optional false
          npm install --prefer-offline --no-audit || true
        env:
          npm_config_build_from_source: false
      - name: Rebuild native modules
        run: npx @electron/rebuild -f -w better-sqlite3
      - run: npm run build --if-present
      - name: 读取当前版本号
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      - run: npm run package-win
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.exe
          path: ./target/firefire Setup ${{steps.version.outputs.value}}.exe

  # macOS Intel (x64) build
  build-mac-x64:
    runs-on: macos-15-intel  # Intel runner
    strategy:
      matrix:
        node-version: [16.x]
    env:
      CI: false
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm config set optional false
    - run: npm install --no-audit
    - run: npm install dmg-license --save-dev
    - name: Rebuild native modules for x64
      run: npx @electron/rebuild -f -w better-sqlite3 --arch=x64
    - run: npm run build --if-present
    - name: 读取当前版本号
      id: version
      uses: ashley-taylor/read-json-property-action@v1.0
      with:
        path: ./package.json
        property: version
    - run: npm run package-mac-x64
    - name: Rename DMG
      run: mv "./target/firefire-${{steps.version.outputs.value}}.dmg" "./target/firefire-${{steps.version.outputs.value}}-x64.dmg" || mv "./target/firefire-${{steps.version.outputs.value}}-x64.dmg" "./target/firefire-${{steps.version.outputs.value}}-x64.dmg"
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: firefire-${{steps.version.outputs.value}}-x64.dmg
        path: ./target/firefire-${{steps.version.outputs.value}}-x64.dmg

  # macOS Apple Silicon (arm64) build
  build-mac-arm64:
    runs-on: macos-latest  # Apple Silicon runner
    strategy:
      matrix:
        node-version: [16.x]
    env:
      CI: false
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm config set optional false
    - run: npm install --no-audit
    - run: npm install dmg-license --save-dev
    - name: Rebuild native modules for arm64
      run: npx @electron/rebuild -f -w better-sqlite3 --arch=arm64
    - run: npm run build --if-present
    - name: 读取当前版本号
      id: version
      uses: ashley-taylor/read-json-property-action@v1.0
      with:
        path: ./package.json
        property: version
    - run: npm run package-mac-arm64
    - name: Rename DMG
      run: mv "./target/firefire-${{steps.version.outputs.value}}.dmg" "./target/firefire-${{steps.version.outputs.value}}-arm64.dmg" || mv "./target/firefire-${{steps.version.outputs.value}}-arm64.dmg" "./target/firefire-${{steps.version.outputs.value}}-arm64.dmg"
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: firefire-${{steps.version.outputs.value}}-arm64.dmg
        path: ./target/firefire-${{steps.version.outputs.value}}-arm64.dmg

  release:
    runs-on: ubuntu-latest
    needs: ['build-mac-x64', 'build-mac-arm64', 'build-win', 'build-linux']
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 16.x
        uses: actions/setup-node@v4
        with:
          node-version: 16.x
          cache: 'npm'
      - name: 读取当前版本号
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      - name: create GitHub Release
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{steps.version.outputs.value}}
          release_name: v${{steps.version.outputs.value}}
          draft: false
          prerelease: false
      # Upload macOS x64
      - name: Download mac x64
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}-x64.dmg
      - name: Upload Release mac x64
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}-x64.dmg
          asset_name: firefire-${{steps.version.outputs.value}}-x64.dmg
          asset_content_type: application/octet-stream
      # Upload macOS arm64
      - name: Download mac arm64
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}-arm64.dmg
      - name: Upload Release mac arm64
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}-arm64.dmg
          asset_name: firefire-${{steps.version.outputs.value}}-arm64.dmg
          asset_content_type: application/octet-stream
      # Upload Windows
      - name: Download win
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.exe
      - name: Upload Release win
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire Setup ${{steps.version.outputs.value}}.exe
          asset_name: firefire-${{steps.version.outputs.value}}.exe
          asset_content_type: application/octet-stream
      # Upload Linux
      - name: Download linux
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.deb
      - name: Upload Release linux
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}.deb
          asset_name: firefire-${{steps.version.outputs.value}}.deb
          asset_content_type: application/octet-stream

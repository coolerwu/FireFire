# Build and release workflow for FireFire
# Builds for Windows, macOS (Intel + Apple Silicon), and Linux

name: build release

on:
  push:
    branches: [ "master" ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [ 18.x ]
    env:
      CI: false
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm install --omit=optional --no-audit
      - name: Remove canvas if present
        run: rm -rf node_modules/canvas || true
      - name: Rebuild native modules
        run: npx @electron/rebuild -f -w better-sqlite3
      - run: npm run build --if-present
      - name: 读取当前版本号
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      - run: npm run package-linux
      - run: mv ./target/firefire_${{steps.version.outputs.value}}_amd64.deb ./target/firefire-${{steps.version.outputs.value}}.deb
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.deb
          path: ./target/firefire-${{steps.version.outputs.value}}.deb

  build-win:
    runs-on: windows-latest
    strategy:
      matrix:
        node-version: [ 18.x ]
    env:
      CI: false
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Setup Python for node-gyp
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: npm install --omit=optional --prefer-offline --no-audit || true
      - name: Remove canvas if present
        run: if exist node_modules\canvas rmdir /s /q node_modules\canvas
        shell: cmd
      - name: Rebuild native modules
        run: npx @electron/rebuild -f -w better-sqlite3
      - run: npm run build --if-present
      - name: 读取当前版本号
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      - run: npm run package-win
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.exe
          path: ./target/firefire Setup ${{steps.version.outputs.value}}.exe

  # macOS Intel (x64) build
  build-mac-x64:
    runs-on: macos-15-intel  # Intel runner
    strategy:
      matrix:
        node-version: [18.x]
    env:
      CI: false
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm install --omit=optional --no-audit
    - run: npm install dmg-license --save-dev
    - name: Remove canvas if present
      run: rm -rf node_modules/canvas || true
    - name: Rebuild native modules for x64
      run: npx @electron/rebuild -f -w better-sqlite3 --arch=x64
    - run: npm run build --if-present
    - name: 读取当前版本号
      id: version
      uses: ashley-taylor/read-json-property-action@v1.0
      with:
        path: ./package.json
        property: version
    - name: Kill processes that may lock DMG
      run: |
        # Kill Finder to prevent it from locking DMG mount
        killall Finder || true
        # Detach any existing DMG mounts
        hdiutil detach /Volumes/firefire* -force 2>/dev/null || true
        # Wait for cleanup
        sleep 2
    - name: Build DMG with retry
      run: |
        for i in 1 2 3; do
          echo "Attempt $i..."
          npm run package-mac-x64 && break
          echo "Build failed, cleaning up and retrying..."
          hdiutil detach /Volumes/firefire* -force 2>/dev/null || true
          sleep 5
        done
    - name: Rename DMG
      run: mv "./target/firefire-${{steps.version.outputs.value}}.dmg" "./target/firefire-${{steps.version.outputs.value}}-x64.dmg" || mv "./target/firefire-${{steps.version.outputs.value}}-x64.dmg" "./target/firefire-${{steps.version.outputs.value}}-x64.dmg"
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: firefire-${{steps.version.outputs.value}}-x64.dmg
        path: ./target/firefire-${{steps.version.outputs.value}}-x64.dmg
    - name: Find and rename ZIP
      run: |
        echo "Looking for ZIP files in ./target:"
        ls -la ./target/*.zip || echo "No zip files found"
        VERSION="${{steps.version.outputs.value}}"
        # Try different possible filenames
        if [ -f "./target/firefire-${VERSION}-x64-mac.zip" ]; then
          mv "./target/firefire-${VERSION}-x64-mac.zip" "./target/firefire-${VERSION}-x64.zip"
        elif [ -f "./target/firefire-${VERSION}-mac.zip" ]; then
          mv "./target/firefire-${VERSION}-mac.zip" "./target/firefire-${VERSION}-x64.zip"
        elif [ -f "./target/firefire-${VERSION}.zip" ]; then
          mv "./target/firefire-${VERSION}.zip" "./target/firefire-${VERSION}-x64.zip"
        fi
        echo "After rename:"
        ls -la ./target/*.zip || echo "No zip files"
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: firefire-${{steps.version.outputs.value}}-x64.zip
        path: ./target/firefire-${{steps.version.outputs.value}}-x64.zip
    - name: Upload latest-mac.yml
      uses: actions/upload-artifact@v4
      with:
        name: latest-mac-x64.yml
        path: ./target/latest-mac.yml

  # macOS Apple Silicon (arm64) build
  build-mac-arm64:
    runs-on: macos-latest  # Apple Silicon runner
    strategy:
      matrix:
        node-version: [18.x]
    env:
      CI: false
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm install --omit=optional --no-audit
    - run: npm install dmg-license --save-dev
    - name: Remove canvas if present
      run: rm -rf node_modules/canvas || true
    - name: Rebuild native modules for arm64
      run: npx @electron/rebuild -f -w better-sqlite3 --arch=arm64
    - run: npm run build --if-present
    - name: 读取当前版本号
      id: version
      uses: ashley-taylor/read-json-property-action@v1.0
      with:
        path: ./package.json
        property: version
    - name: Kill processes that may lock DMG
      run: |
        # Kill Finder to prevent it from locking DMG mount
        killall Finder || true
        # Detach any existing DMG mounts
        hdiutil detach /Volumes/firefire* -force 2>/dev/null || true
        # Wait for cleanup
        sleep 2
    - name: Build DMG with retry
      run: |
        for i in 1 2 3; do
          echo "Attempt $i..."
          npm run package-mac-arm64 && break
          echo "Build failed, cleaning up and retrying..."
          hdiutil detach /Volumes/firefire* -force 2>/dev/null || true
          sleep 5
        done
    - name: Rename DMG
      run: mv "./target/firefire-${{steps.version.outputs.value}}.dmg" "./target/firefire-${{steps.version.outputs.value}}-arm64.dmg" || mv "./target/firefire-${{steps.version.outputs.value}}-arm64.dmg" "./target/firefire-${{steps.version.outputs.value}}-arm64.dmg"
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: firefire-${{steps.version.outputs.value}}-arm64.dmg
        path: ./target/firefire-${{steps.version.outputs.value}}-arm64.dmg
    - name: Find and rename ZIP
      run: |
        echo "Looking for ZIP files in ./target:"
        ls -la ./target/*.zip || echo "No zip files found"
        VERSION="${{steps.version.outputs.value}}"
        # Try different possible filenames
        if [ -f "./target/firefire-${VERSION}-arm64-mac.zip" ]; then
          mv "./target/firefire-${VERSION}-arm64-mac.zip" "./target/firefire-${VERSION}-arm64.zip"
        elif [ -f "./target/firefire-${VERSION}-mac.zip" ]; then
          mv "./target/firefire-${VERSION}-mac.zip" "./target/firefire-${VERSION}-arm64.zip"
        elif [ -f "./target/firefire-${VERSION}.zip" ]; then
          mv "./target/firefire-${VERSION}.zip" "./target/firefire-${VERSION}-arm64.zip"
        fi
        echo "After rename:"
        ls -la ./target/*.zip || echo "No zip files"
    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: firefire-${{steps.version.outputs.value}}-arm64.zip
        path: ./target/firefire-${{steps.version.outputs.value}}-arm64.zip
    - name: Upload latest-mac.yml
      uses: actions/upload-artifact@v4
      with:
        name: latest-mac-arm64.yml
        path: ./target/latest-mac.yml

  release:
    runs-on: ubuntu-latest
    needs: ['build-mac-x64', 'build-mac-arm64', 'build-win', 'build-linux']
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'
      - name: 读取当前版本号
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      - name: create GitHub Release
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{steps.version.outputs.value}}
          release_name: v${{steps.version.outputs.value}}
          draft: false
          prerelease: false
      # Upload macOS x64
      - name: Download mac x64
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}-x64.dmg
      - name: Upload Release mac x64
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}-x64.dmg
          asset_name: firefire-${{steps.version.outputs.value}}-x64.dmg
          asset_content_type: application/octet-stream
      # Upload macOS arm64
      - name: Download mac arm64
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}-arm64.dmg
      - name: Upload Release mac arm64
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}-arm64.dmg
          asset_name: firefire-${{steps.version.outputs.value}}-arm64.dmg
          asset_content_type: application/octet-stream
      # Upload macOS x64 ZIP for auto-update
      - name: Download mac x64 zip
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}-x64.zip
      - name: Upload Release mac x64 zip
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}-x64.zip
          asset_name: firefire-${{steps.version.outputs.value}}-x64.zip
          asset_content_type: application/zip
      # Upload macOS arm64 ZIP for auto-update
      - name: Download mac arm64 zip
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}-arm64.zip
      - name: Upload Release mac arm64 zip
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}-arm64.zip
          asset_name: firefire-${{steps.version.outputs.value}}-arm64.zip
          asset_content_type: application/zip
      # Upload Windows
      - name: Download win
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.exe
      - name: Upload Release win
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire Setup ${{steps.version.outputs.value}}.exe
          asset_name: firefire-${{steps.version.outputs.value}}.exe
          asset_content_type: application/octet-stream
      # Upload Linux
      - name: Download linux
        uses: actions/download-artifact@v4
        with:
          name: firefire-${{steps.version.outputs.value}}.deb
      - name: Upload Release linux
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./firefire-${{steps.version.outputs.value}}.deb
          asset_name: firefire-${{steps.version.outputs.value}}.deb
          asset_content_type: application/octet-stream
      # Generate combined latest-mac.yml for auto-update with both architectures
      - name: Download latest-mac-arm64.yml
        uses: actions/download-artifact@v4
        with:
          name: latest-mac-arm64.yml
          path: ./yml-arm64
      - name: Download latest-mac-x64.yml
        uses: actions/download-artifact@v4
        with:
          name: latest-mac-x64.yml
          path: ./yml-x64
      - name: Generate combined latest-mac.yml
        run: |
          VERSION=${{steps.version.outputs.value}}
          ARM64_ZIP="firefire-${VERSION}-arm64.zip"
          X64_ZIP="firefire-${VERSION}-x64.zip"

          echo "=== Parsing yml files ==="
          echo "ARM64 yml content:"
          cat ./yml-arm64/latest-mac.yml
          echo ""
          echo "X64 yml content:"
          cat ./yml-x64/latest-mac.yml

          # Extract sha512 - try multiple patterns for robustness
          ARM64_SHA512=$(grep -E '^sha512:|^  sha512:' ./yml-arm64/latest-mac.yml | head -1 | sed 's/.*sha512: *//')
          X64_SHA512=$(grep -E '^sha512:|^  sha512:' ./yml-x64/latest-mac.yml | head -1 | sed 's/.*sha512: *//')

          # Extract size from files section
          ARM64_SIZE=$(grep -E 'size:' ./yml-arm64/latest-mac.yml | head -1 | sed 's/.*size: *//')
          X64_SIZE=$(grep -E 'size:' ./yml-x64/latest-mac.yml | head -1 | sed 's/.*size: *//')

          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          echo "=== Extracted values ==="
          echo "ARM64_SHA512: ${ARM64_SHA512}"
          echo "X64_SHA512: ${X64_SHA512}"
          echo "ARM64_SIZE: ${ARM64_SIZE}"
          echo "X64_SIZE: ${X64_SIZE}"

          # Validate extracted values
          if [ -z "$ARM64_SHA512" ] || [ -z "$X64_SHA512" ]; then
            echo "ERROR: Failed to extract sha512 values!"
            exit 1
          fi

          cat > latest-mac.yml << EOF
          version: ${VERSION}
          files:
            - url: ${ARM64_ZIP}
              sha512: ${ARM64_SHA512}
              size: ${ARM64_SIZE}
              arch: arm64
            - url: ${X64_ZIP}
              sha512: ${X64_SHA512}
              size: ${X64_SIZE}
              arch: x64
          path: ${ARM64_ZIP}
          sha512: ${ARM64_SHA512}
          releaseDate: '${RELEASE_DATE}'
          EOF

          # Remove leading spaces from YAML (heredoc indentation issue)
          sed -i 's/^          //' latest-mac.yml

          echo "=== Generated latest-mac.yml ==="
          cat latest-mac.yml
      - name: Upload latest-mac.yml
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          upload_url: ${{steps.create_release.outputs.upload_url}}
          asset_path: ./latest-mac.yml
          asset_name: latest-mac.yml
          asset_content_type: text/yaml
